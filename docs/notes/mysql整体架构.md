---
title: mysql整体架构
permalink: /post/mysql-overall-architecture-z1k0unn.html
date: 2023-01-04 22:33:39
meta:
  - name: keywords
    content: ''
  - name: description
    content: >-
      mysql整体架构本文参考了小林coding的图解mysql(强烈推荐)和稀土掘金社区at_竹子爱熊猫的文章总览​​连接层_主要是指数据库连接池会负责处理所有客户端接入的工作。服务层_主要包含sql​接口解析器优化器以及缓存缓冲区四块区域。存储引擎层_这里是指mysql​​支持的各大存储引擎如innodbmyisam​​等。文件系统层_涵盖了所有的日志以及数据索引文件位于系统硬盘上网络连接层连接协议_tcpip协议​连接过程_step_mysqlhurootp​h​表示mysql​所在的服务器ip​地址​
tags: []
categories: []
author:
  name: XDUcoderT
  link: https://github.com/XDUcoderT
---

# mysql整体架构

> 本文参考了小林coding的图解mysql(强烈推荐) 和 稀土掘金社区@竹子爱熊猫的文章

## 总览

​![MySQL整体架构](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/11dda1407ff5426285aa18102c2113c4~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp?)​

* **连接层**：主要是指**数据库连接池**，会负责处理所有客户端接入的工作。
* **服务层**：主要包含**`SQL`**​**接口、解析器、优化器以及缓存缓冲区**四块区域。
* **存储引擎层**：这里是指`MySQL`​​支持的各大存储引擎，如`InnoDB、MyISAM`​​等。
* **文件系统层**：涵盖了所有的**日志**，以及**数据**、**索引文件**，位于系统硬盘上

## 网络连接层

* 连接协议：**TCP/IP协议 ​**
* 连接过程：

  * step1:

  ```sql
  mysql -h 127.0.0.1 -uroot -p123456
  ```

  ​`-h`​表示`MySQL`​所在的服务器`IP`​地址

  ​`-u`​表示本次连接所使用的用户名

  ​`-p`​则代表着当前用户的账号密码

  * ​	step2:

    **TCP的3次握手**
  * ​	step3:  
    **建立成功后，服务端和客户端之间会建立一个session会话**
  * ​	step4:

    **对登录的用户名和密码进行校验**
  * ​    step5：

    **进行授权操作，查询每个用户的权限，并对其授权**
  * ​    step6：

    mysql会安排一条**线程维护当前客户端的连接**，这条线程也会时刻标识着当前连接的在干什么工作，可以通过`show processlist;`​​命令查询所有正在运行的线程：
* 补充

  * mysql和客户端采用的是半双工的通讯机制
  * 通讯机制

    * 全双工：通讯的双方的同一时刻，即可以发送数据，也可以接收数据
    * 半双工：同一时刻，单方只能发送数据或接收数据
    * 单工：当前连接只能发送数据或只能接收数据
  * 一些连接池参数及查询语句：

    * 最大连接数max_connections

    ```sql
    mysql> show variables like 'max_connections';
    ```

    * 空闲连接的最大空闲时长wait_timeout

    ```sql
    mysql> show variables like 'wait_timeout';
    +---------------+-------+
    | Variable_name | Value |
    +---------------+-------+
    | wait_timeout  | 28800 |
    +---------------+-------+
    1 row in set (0.00 sec)
    ```

    * 统计客户端的连接数

      ```
      mysql> show status like "Threads%"

      ```
    * ​`Threads_cached`​：目前空闲的数据库连接数。

    ​   缓存连接池中可用的连接数量

    * ​`Threads_connected`​：当前数据库存活的数据库连接数。
    * ​`Threads_created`​：`MySQL-Server`​运行至今，累计创建的连接数。
    * ​`Threads_running`​：目前正在执行的数据库连接数。

## 系统服务层

### 触发器 ———— mysql中的“aop”

触发器可视为是一种特殊的存储过程，不同的是存储过程需要手动调用后才可执行，而**触发器可由某个事件主动触发执行**  
​`MySQL`​​中支持**`INSERT、UPDATE、DELETE`**​**三种事件触发**，同时也可以通过`AFTER、BEFORE`​​语句声明触发的时机，是在操作执行之前还是执行之后。

### 解析器 ———— Grammar Error管家

进行词法分析和语法分析，构建语法树balabala...

### 预处理器 ———— 帮解析器擦擦p股

1. 检查 SQL 查询语句中的**表或者字段是否存在**；
2. **将 select * 中的 * 符号，扩展为表上的所有列**

### 优化器 ———— 计划指定者

优化器就是整个系统的军师，会给出最合适的索引和join方式等。

### 执行器 ———— 出色的打工人

执行语句，然后从存储引擎返回数据。 执行语句之前会先判断是否有权限，如果没有权限的话，就会报错。通常采取以下三种方式

* 主键索引查询
* 全表扫描
* 索引下推(ICP)  
  索引下推的下推其实就是指**将部分上层（服务层）负责的事情，交给了下层（引擎层）去处理。**  
  在没有使用ICP的情况下，MySQL的查询：

  > 存储引擎读取索引记录；  
  > 根据索引中的主键值，定位并读取完整的行记录；  
  > **存储引擎把记录交给Server层去检测该记录是否满足WHERE条件。**
  >

  使用ICP的情况下，查询过程：

  > 存储引擎读取索引记录（不是完整的行记录）；  
  > **判断WHERE条件部分能否用索引中的列来做检查**，条件不满足，则处理下一行索引记录；  
  > **条件满足，使用索引中的主键去定位并读取完整的行记录（就是所谓的回表）**；  
  > 存储引擎把记录交给Server层，Server层检测该记录是否满足WHERE条件的其余部分。
  >

## 存储引擎层

​存储引擎是`MySQL`​​数据库中与磁盘文件打交道的子系统，不同的引擎底层访问文件的机制也存在些许细微差异，引擎也不仅仅只负责数据的管理，也会负责库表管理、索引管理等，`MySQL`​​中所有与磁盘打交道的工作，最终都会交给存储引擎来完成。

常见存储引擎：InnoDB MyISAM

可以通过`show engines`​命令来查看mysql支持的所有存储引擎。

​![](https://xducodert-blog.oss-cn-chengdu.aliyuncs.com/test/image-20230121181931-4c2eosr.png)​

mysql当前默认的存储引擎是InnoDB。并且，所**有的存储引擎只有InnoDB是事务性存储引擎**，也就是说只有InnoDB支持事务

mysql存储引擎采用的是插件式架构，支持多种存储引擎，存储引擎式基于表的，而不是数据库，我**们可以为不同固定数据库表设置不同的存储引擎以适应不同场景的需要**。

### MyISAM和InnoDB的区别是什么？

1. **是否支持行级锁**

    * MyISAM只有表级锁，而InnoDB支持行级锁和表级锁，默认为行级锁。
    * 也就是说，MyISAM如果要上锁的话，只能锁住整张表，这在并发写的时候性能不如InnoDB
2. **是否支持事务**

    * MyISAM不提供事务支持
    * InnoDB提供事务支持，实现了SQL标准定义的四个隔离级别，具有提交(commit)和回滚(rollback)事务的能力

      并且，InnoDB默认使用的`可重复读`​隔离级别可以解决幻读问题(基于MVCC和Next-Key Lock)
3. **是否支持外键**

    MyISAM不支持，InnoDB支持。

    外键对于维护数据一致性非常有帮助，**但是对性能有一定的损耗。**因此，在通常情况下，不建议在实际生产项目中使用外键。

    阿里的《Java开发手册》也是明确规定禁止使用外键的。

    ​![](https://xducodert-blog.oss-cn-chengdu.aliyuncs.com/test/image-20230121183950-63rcy1r.png)
4. **是否支持数据库异常崩溃后的安全恢复**

    MyISAM不支持，而InnoDB支持

    使用InnoDB的数据库在异常崩溃后，数据库重新启动的时候会保证数据库恢复到崩溃前的状态，这个恢复的过程依赖于`redo log`​
5. **是否支持MVCC**

    MyISAM 不支持，而 InnoDB 支持。

    讲真，这个对比有点废话，毕竟 MyISAM 连行级锁都不支持。MVCC 可以看作是行级锁的一个升级，可以有效减少加锁操作，提高性能。
6. **文件存储方式不一样**

    虽然**MyISAM引擎和InnoDB引擎都是使用B+Tree作为索引结构**，但是两者的实现方式不一样。

    InnoDB引擎中，其数据文件本身就是索引文件。相比MyISAM，索引文件和数据文件是分离的，其表数据文件本身就是按B+Tree组织的一个索引结构，树的叶节点data域保存了完整的数据记录

**锁事外崩M文**

## 文件系统层

### 日志模块

 在MySQL中主要存在七种常用的日志类型，如下：

> ①binlog二进制日志，主要记录MySQL数据库的所有写操作（增删改）。  
> ②redo-log重做/重写日志，MySQL崩溃时，对于未落盘的操作会记录在这里面，用于重启时重新落盘（InnoDB专有的）。  
> ③undo-logs撤销/回滚日志：记录事务开始前[修改数据]的备份，用于回滚事务。  
> ④error-log：错误日志：记录MySQL启动、运行、停止时的错误信息。  
> ⑤general-log常规日志，主要记录MySQL收到的每一个查询或SQL命令。  
> ⑥slow-log：慢查询日志，主要记录执行时间较长的SQL。  
> ⑦relay-log：中继日志，主要用于主从复制做数据拷贝。

### 数据文件模块

这里主要说4类文件类型，可以看出INNODB是聚集索引类型，他把索引和数据全部放在一个文件里，MyISAM是稀疏索引类型，讲索引和数据放在不同文件中，b+树叶子节点存的是具体数据所在磁盘地址(mysql底层数据结构后续会单独写一篇文章)

> .frm文件：存储表结构的元数据信息文件，每张表都会有一个这样的文件。  
> .MYD文件：用于存储表中所有数据的文件（MyISAM引擎独有的）。  
> .MYI文件：用于存储表中索引信息的文件（MyISAM引擎独有的）。  
> .ibd文件：用于存储表数据和索引信息的文件（InnoDB引擎独有的）。

‍
